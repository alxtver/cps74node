<script src="/pc.js"></script>
<h1>Производство</h1>
<button class="btn btn-dark mb-2" onclick="location.href='pc/add';">Добавить ПЭВМ</button>

<form>
  <div class="form-group">
    <label for="part_select">Партия</label>
    <select class="form-control" id="part_select">

    </select>
  </div>
<input type="hidden" name="_csrf" value="{{csrf}}">
</form>

<div id="PC"></div>
<input type="hidden" id="hidd_id" value="0">
<input type="hidden" id="hidd_obj" value="0">
<input type="hidden" id="hidd_unit" value="0">

<!-- Modal -->

<div class="modal fade" id="modalCopy" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Серийный номер</h5>
        
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="/pc/copy" method="post">
      <input type="hidden" name="_csrf" value="{{csrf}}">
      <div class="modal-body">
        {{!-- <input class="danger" id="danger" type="hidden" value="Такой серийный номер существует"> --}}
        
        
        <input id="inputCopy" name="serial_number" type="text" value="" class="form-control">
        <div class="mb-2" id="hidd"></div>
      </div>
      <input type="hidden" name="id" id="hidInputCopy">
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
        <button type="submit" id="btnSubmit" class="btn btn-primary" disabled>Сохранить</button>
        
      </div>
      </form>
    </div>
  </div>
</div>


<script>
  $(document).ready(function () {
    load_data(`{{part}}`)
    load_part()  
  })

  $(document).on('change', '#part_select', function () {
    load_data($("#part_select :selected").text())
  })


  $("body").on('click','.copyBtn',function () {
    $('#hidInputCopy').val($(this).data("id"))
    $('#inputCopy').val($(this).data("serial_number"))
  })

  $(document).on('blur', '.serial_number', function () {
    let id = $(this).data("id")
    let obj = $(this).data("obj")
    let unit = $(this).data("unit")
    let serial_number = $(this).text()
    let data_hidd = $(this).data("data")
    $("#hidd_id").val(data_hidd)
  })

  $(document).on('keypress', '.serial_number', function (e) {
    let id = $(this).data("obj")
    if (e.which == 13) {
      let id = $(this).data("id")
      let obj = $(this).data("obj")
      let unit = $(this).data("unit")
      let serial_number = $(this).text()
      let data_hidd = $(this).data("data")
      let data_apkzi = $(this).data("apkzi")

      $("#hidd_id").val(data_hidd)

      if (data_apkzi) {
        edit_serial_number_apkzi(id, obj, unit, serial_number)
      } else {
        edit_serial_number(id, obj, unit, serial_number)
      }
      
      
      let current_id = $("#hidd_id").val()
      let next_id = current_id.split(";")
      next_id[1] = Number(next_id[1]) + 1 + ''
      
      $(".serial_number[data-data='" + next_id.join(';') + "']").focus()
      setTimeout(function () {
        $(".serial_number[data-data='" + next_id.join(';') + "']").focus()
      }, 1000)
    }
  })

  $('#inputCopy').keyup(function() {
      let serial = $(this).val()
      find_serial(serial)
    })
</script>